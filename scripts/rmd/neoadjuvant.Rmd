---
title: \texttt{immunoSeqR} Analysis
#author: "Alex Hopkins"
output: pdf_document
header-includes:
   - \usepackage{graphicx}
---
# Neoadjuvant Study
Created `r  format(Sys.Date(),"%m/%d/%y")`

```{r eval=TRUE,echo=FALSE}
require(immunoSeqR)
require(ggplot2)
require(gridExtra)
require(reshape2)
first_run <- FALSE
verbose=FALSE

```
```{r eval=first_run}
load('~/Documents/emj/ImmunoseqResults/mega/ds_agg.Rda')
load('~/Documents/emj/ImmunoseqResults/mega/dict.Rda')
load('~/Documents/emj/ImmunoseqResults/mega/stats.Rda')
```
```{r eval=first_run,echo=verbose,warn=FALSE}
if(!all(unlist(iseqr_check(ds,dict,stats)))){stop('Check dictionary and stats.')}
w <- which(dict$experiment=='Neoadjuvant')
ds <- ds[,c(w,1,2)] # put syn and aa on the end, then dictionary does not need to be padded
ds <- iseqr_clean_ds(ds)
stats <- stats[w-2,]
dict <- dict[w,] # will result in an unpadded dictionary, but will work with new ds
dict <- refactor(dict)
olm <- olm[w-2,w-2]
mm <- mm[w-2,w-2]
if(!all(unlist(iseqr_check(ds,dict,stats)))){stop('Error collapsing dictionary or stats.')}
a <- gc()
```
## Background
\includegraphics[width=\textwidth]{/home/ahopkins/Documents/emj/figures/J0810_timeline.pdf}

### Dataset

The data set contains `r ncol(ds)-2` samples, of `r length(levels(dict$type))` types. 
There are `r format(nrow(ds),big.mark=',')` unique TCRs, collapsed from `r 
format(sum(ds$syn),big.mark=',')` distinct productive CDR3 sequences. This represents an average 
synonymity of `r summary(ds$syn)['Mean']`. The maximum synonymity (in the parent data set) was `r 
summary(ds$syn)['Max.']` (clone sequence `r ds$aa[which.max(ds$syn)]`).\par

### Metadata  
The available metadata fields in the dictionary are: `r paste(names(dict)[-1],collapse=', ')`. The statistics computed are `r paste(names(stats)[names(stats)!='fn'],collapse=', ')`.

\clearpage


### By Response

```{r eval=TRUE,echo=verbose,cache=FALSE}
#put sum of seqs at the end
stats <- stats[,c(1,3,2,4)]
plot_ds <- merge(dict,stats)
```
```{r echo=verbose,fig.align='center'}
x_val <- 'response'
metrics <- names(stats[names(stats)!='fn'])
types <- levels(plot_ds$type)
for(b in metrics){
	l <- vector('list')
	for(a in types){
	    l[[a]] <- iseqr_plot_factor(plot_ds,b,x_val,a)
	}
	do.call(grid.arrange,c(l,ncol=length(types)))
}
```
\clearpage

### By Type
```{r echo=verbose,fig.align='center'}
metrics <- names(stats[names(stats)!='fn'])
l <- vector('list')
for(b in metrics){
        l[[b]] <- iseqr_plot_factor(plot_ds,b,'type',NA) + theme(axis.text=element_text(size=5))
}
    do.call(grid.arrange,c(l,ncol=length(types)))

```
\clearpage

## Overlaps

```{r echo=verbose,eval=TRUE,fig.align='center',fig.height=8}
rownames(olm) <- paste0(dict$patient,dict$type)
colnames(olm) <- rownames(olm)
w <- c(which(dict$response=='NR'),which(dict$response=='R'))
tdict <- dict[w,]
tolm <- olm[w,w]
tolm.m <- melt(tolm)
g <- ggplot(tolm.m,aes(x=Var1,y=Var2)) +
    geom_tile(aes(fill=value)) +
    coord_fixed() +
    scale_fill_gradient(low='white',high='black')+
    theme(axis.text=element_text(size=5,colour=tdict$response),
            axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
    xlab('') + ylab('') + ggtitle('Overlap')
g
```
\clearpage

## Confounders

### Treatment Arm

```{r echo=verbose,cache=FALSE,fig.align='center',fig.height=3}
x_val <- 'arm'
metrics <- names(stats[names(stats)!='fn'])
types <- levels(plot_ds$type)
for(b in metrics){
    l <- vector('list')
    for(a in types){
        l[[a]] <- iseqr_plot_factor(plot_ds,b,x_val,a)
    }
    do.call(grid.arrange,c(l,ncol=length(types)))
}
```
\clearpage

### Age

```{r echo=verbose,cache=FALSE,fig.align='center',fig.height=2.5}
x_val <- 'age'
metrics <- names(stats[names(stats)!='fn'])
types <- levels(plot_ds$type)
for(b in metrics){
    l <- vector('list')
    for(a in types){
        l[[a]] <- iseqr_plot_metrics(plot_ds,b,x_val,a,sm=TRUE)
    }
    do.call(grid.arrange,c(l,ncol=length(types)))
	cat('  \n')
}
```
\clearpage

### Cell Number

```{r echo=verbose,cache=FALSE,fig.align='center',fig.height=2.5,fig.width=8}
x_val <- 'cells'
metrics <- names(stats[names(stats)!='fn'])
types <- levels(plot_ds$type)
for(b in metrics){
    l <- vector('list')
    for(a in types[types!='PDAC']){
        l[[a]] <- iseqr_plot_metrics(plot_ds[!is.na(plot_ds$cells),],b,x_val,a) + 
					theme(axis.text=element_text(size=5))
    }
    do.call(grid.arrange,c(l,ncol=length(types)))  
	cat('  \n')
}
```
